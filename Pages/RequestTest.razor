@page "/request"

@using System.IO
@using System.Net
@using System.Text.Json
@using Components

<input type="text" @bind-value="@InputValue" />
<input type="submit" onclick="@(() => OnSubmit())" />

<button @onclick="ExpandAll">Expand All</button>

<JsonObjectViewer ObjectData="@jsonObject" @bind-ExpandAll="expandAll" />

@code
{
    public string InputValue { get; set; } = "";
    public string Response { get; set; } = "";
    private bool expandAll = false;

    private void ExpandAll()
    {
        expandAll = !expandAll;
        StateHasChanged();
    }

    private JsonElement jsonObject = JsonSerializer.Deserialize<JsonElement>("{}");

    private async Task OnSubmit()
    {
        HttpClient _client = new HttpClient();

        using(HttpResponseMessage response = await _client.GetAsync(
            "https://vpic.nhtsa.dot.gov/api/vehicles/decodevin/" + InputValue + "?format=json"
        ))
        {
            var data = await response.Content.ReadAsStringAsync();
            if(data != null)
            {
                var options = new JsonSerializerOptions(){
                    WriteIndented = true
                };

                Response = JsonSerializer.Serialize(JsonSerializer.Deserialize<JsonElement>(data), options);
                jsonObject = JsonSerializer.Deserialize<JsonElement>(Response);
                StateHasChanged();
            }
        }
    }
}